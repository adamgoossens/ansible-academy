- name: "Configure load balancer"
  hosts: localhost
  tasks:
    - name: Create target group
      community.aws.elb_target_group:
        name: "{{academy_user}}-webserver-group"
        protocol: http
        port: 80
        vpc_id: "{{ aws.vpc }}"
        region: "{{ aws.region }}"
        state: present

    - name: Create one target per webserver VM
      community.aws.elb_target:
        target_group_name: "{{academy_user}}-webserver-group"
        target_id: "{{ instance['instance_id'] }}"
        state: present
        region: "{{ aws.region }}"
      vars:
        instance: "{{ hostvars[item] }}"
      loop: "{{ groups['webservers'] }}"

    - name: Establish AWS load balancer
      community.aws.elb_application_lb:
        name: "{{ academy_user }}-webserver-lb"
        region: "{{ aws.region }}"
        subnets:
          - "{{ aws.subnet_az_a }}"
          - "{{ aws.subnet_az_b }}"
        security_groups:
          - "{{ aws.securitygroup }}"
        listeners:
          - Protocol: HTTP
            Port: 80
            DefaultActions:
              - Type: forward
                TargetGroupName: "{{ academy_user }}-webserver-group"
        tags:
          Name: "{{ academy_user }}-webserver-lb"

        state: present
      register: elb

    - name: Create Route53 record for load balancer
      community.aws.route53:
        alias: yes
        alias_hosted_zone_id: "{{ elb.canonical_hosted_zone_id }}"
        record: "{{ academy_user }}.{{ aws.hosted_zone }}"
        value: "{{ elb.dns_name }}"
        type: "A"
        zone: "{{ aws.hosted_zone }}."
        state: present
