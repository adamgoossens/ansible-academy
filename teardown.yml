- name: "Destroy environment"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "{{ academy_user }} - destroy virtual machines"
      amazon.aws.ec2_instance:
        state: absent
        wait: true
        region: "{{ aws.region }}"
        filters:
          'tag:User': '{{ academy_user }}'

    - name: "{{ academy_user }} - fetch Route53 record"
      community.aws.route53:
        state: get
        record: "{{ academy_user }}.{{ aws.hosted_zone }}"
        zone: "{{ aws.hosted_zone }}"
        type: 'A'
      register: rec

    - debug: var=rec

    - name: "{{ academy_user }} - destroy Route53 record"
      community.aws.route53:
        record: "{{ rec.set.record }}"
        zone: "{{ aws.hosted_zone }}"
        state: absent
        type: '{{ rec.set.type }}'
        alias: True
        alias_hosted_zone_id: "{{ rec.set.alias_hosted_zone_id }}"

    - name: "{{ academy_user }} - destroy elb"
      community.aws.elb_application_lb:
        name: "{{ academy_user }}-webserver-lb"
        state: absent
        region: "{{ aws.region }}"

    - name: "{{ academy_user }} - destroy elb target group"
      community.aws.elb_target_group:
        name: "{{academy_user}}-webserver-group"
        state: absent
        region: "{{ aws.region }}"

